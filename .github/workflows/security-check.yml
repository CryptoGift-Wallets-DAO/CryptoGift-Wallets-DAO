name: 🛡️ Security & Quality Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  security-quality-check:
    name: Security & Quality Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: 📦 Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9.15.9
        run_install: false
        
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org/'
        cache: 'pnpm'
        cache-dependency-path: pnpm-lock.yaml
        
    - name: 📦 Install Dependencies
      run: |
        echo "🔍 Installing dependencies with pnpm $(pnpm --version)..."
        pnpm install --frozen-lockfile --prefer-offline
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        
    - name: 🔍 TypeScript Compilation Check  
      run: |
        echo "Running TypeScript check..."
        echo "## 🔍 TypeScript Build Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Run TypeScript check and capture output
        if pnpm run type-check > typescript-output.txt 2>&1; then
          echo "✅ TypeScript compilation successful - No errors found" >> $GITHUB_STEP_SUMMARY
          echo "✅ TypeScript compilation successful"
        else
          # Count total errors
          TOTAL_ERRORS=$(grep -c "error TS" typescript-output.txt || echo "0")
          echo "❌ **TypeScript Build: FAILED** ($TOTAL_ERRORS errors found)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Compilation Errors:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -30 typescript-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "❌ TypeScript build failed with $TOTAL_ERRORS errors"
          echo "🚨 **THIS IS A REAL FAILURE** - Build cannot proceed with TypeScript errors"
          exit 1
        fi
        
    - name: 🧹 ESLint Security Rules
      run: |
        echo "## 🧹 ESLint Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if pnpm run lint > eslint-output.txt 2>&1; then
          echo "✅ **ESLint: PASSED** - No linting issues found" >> $GITHUB_STEP_SUMMARY
          echo "✅ ESLint validation successful"
        else
          echo "❌ **ESLint: FAILED** - Linting issues found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ESLint Issues:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -30 eslint-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "❌ ESLint found linting issues"
          echo "🚨 **THIS IS A REAL FAILURE** - Code quality issues must be fixed"
          exit 1
        fi
        
    - name: 🧪 Run Test Suite
      run: |
        echo "## 🧪 Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if pnpm run test:ci > test-output.txt 2>&1; then
          echo "✅ **Tests: PASSED** - All tests successful" >> $GITHUB_STEP_SUMMARY
          echo "✅ Test suite passed"
        else
          echo "❌ **Tests: FAILED** - Test failures detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Failures:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -20 test-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "❌ Test suite failed"
          echo "🚨 **THIS IS A REAL FAILURE** - Tests must pass before deployment"
          exit 1
        fi
        
    - name: 📊 Coverage Threshold Check (70% minimum)
      run: |
        echo "## 📊 Coverage Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if pnpm run test:coverage > coverage-output.txt 2>&1; then
          # Extract coverage percentage if available
          COVERAGE=$(grep -oP 'All files.*?(\d+\.?\d*)%' coverage-output.txt | tail -1 | grep -oP '\d+\.?\d*' || echo "0")
          if [ $(echo "$COVERAGE > 70" | bc -l 2>/dev/null || echo 0) -eq 1 ]; then
            echo "✅ **Coverage: PASSED** ($COVERAGE% > 70% threshold)" >> $GITHUB_STEP_SUMMARY
            echo "✅ Coverage threshold met: $COVERAGE%"
          else
            echo "⚠️ **Coverage: BELOW THRESHOLD** ($COVERAGE% < 70% required)" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ Coverage below 70%: $COVERAGE%"
          fi
        else
          echo "❌ **Coverage: FAILED** - Could not generate coverage report" >> $GITHUB_STEP_SUMMARY
          echo "❌ Coverage generation failed"
        fi
        
    - name: 🔒 Security Pattern Validation (Non-blocking)
      run: |
        
        # Initialize counters
        WARNINGS=0
        ERRORS=0
        
        # Load enforcement level (default to warning for CI)
        ENFORCEMENT_LEVEL="warning"
        if [ -f "../.security-config.json" ]; then
          ENFORCEMENT_LEVEL=$(node -p "JSON.parse(require('fs').readFileSync('../.security-config.json', 'utf8')).enforcement.level" 2>/dev/null || echo "warning")
        fi
        
        echo "🎚️  CI Security enforcement level: $ENFORCEMENT_LEVEL"
        
        # Check for unprotected API endpoints
        echo "🔍 Checking for unprotected API endpoints..."
        unprotected_endpoints=$(find frontend/src/pages/api -name "*.ts" -exec grep -l "export default async function handler" {} \; 2>/dev/null | while read file; do
          if ! grep -q "checkRateLimit\|verifyJWT\|ADMIN_API_TOKEN" "$file" 2>/dev/null; then
            echo "$file"
          fi
        done)
        
        if [ ! -z "$unprotected_endpoints" ]; then
          echo "⚠️  SECURITY WARNING: Unprotected API endpoints found:"
          echo "$unprotected_endpoints"
          echo "   Consider adding rate limiting or authentication"
          WARNINGS=$((WARNINGS + 1))
        fi
        
        # Check for sensitive data in logs (CRITICAL - always error)
        echo "🔍 Checking for sensitive data patterns..."
        if grep -r "console.log.*private\|console.log.*secret\|console.log.*token" frontend/src/ --include="*.ts" --include="*.tsx" >/dev/null 2>&1; then
          echo "❌ SECURITY ERROR: Potential sensitive data in console.log"
          echo "   This is a critical security risk"
          ERRORS=$((ERRORS + 1))
        fi
        
        # Check for missing test files (WARNING only)
        echo "🔍 Checking for missing test coverage..."
        missing_tests=0
        find frontend/src/lib -name "*.ts" -type f | while read lib_file; do
          base_name=$(basename "$lib_file" .ts)
          if [ ! -f "frontend/src/test/${base_name}.test.ts" ] && [ "$base_name" != "types" ]; then
            echo "⚠️  Missing test file for $lib_file"
            echo "   Expected: frontend/src/test/${base_name}.test.ts"
            missing_tests=$((missing_tests + 1))
          fi
        done
        
        if [ $missing_tests -gt 0 ]; then
          WARNINGS=$((WARNINGS + 1))
        fi
        
        # Summary
        echo ""
        echo "📊 CI Security Summary:"
        echo "   Warnings: $WARNINGS"
        echo "   Errors: $ERRORS"
        echo "   Enforcement Level: $ENFORCEMENT_LEVEL"
        
        # Only fail CI if enforcement is "error" AND there are actual errors
        if [ $ERRORS -gt 0 ] && [ "$ENFORCEMENT_LEVEL" = "error" ]; then
          echo "🚫 CI failing due to critical security errors"
          exit 1
        else
          echo "✅ CI security check completed"
          if [ $WARNINGS -gt 0 ] || [ $ERRORS -gt 0 ]; then
            echo "⚠️  Issues found but deployment allowed (enforcement level: $ENFORCEMENT_LEVEL)"
            echo "🎯 Fix these issues for better security"
          fi
        fi
        
    - name: 🏗️ Production Build Test
      run: |
        echo "## 🏗️ Production Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if timeout 300 pnpm run build > build-output.txt 2>&1; then
          echo "✅ **Production Build: SUCCESS** - Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "✅ Production build successful"
        else
          echo "❌ **Production Build: FAILED** - Build errors detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Errors:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -30 build-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "❌ Production build failed"
          echo "🚨 **THIS IS A REAL FAILURE** - Build must succeed before deployment"
          exit 1
        fi
        
    - name: ✅ Security Gate Passed
      run: |
        echo "🎉 All security and quality checks passed!"
        echo "✅ TypeScript compilation successful"
        echo "✅ ESLint validation passed"  
        echo "✅ Test suite passed with 70%+ coverage"
        echo "✅ Security patterns validated"
        echo "✅ Production build successful"
        echo ""
        echo "🛡️ Code is ready for deployment!"

  security-metrics:
    name: 📊 Security Metrics & Dashboard
    runs-on: ubuntu-latest
    needs: security-quality-check
    if: always()
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: 📦 Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9.15.9
        run_install: false
        
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org/'
        cache: 'pnpm'
        cache-dependency-path: pnpm-lock.yaml
        
    - name: 📦 Install Dependencies
      run: |
        echo "🔍 Installing dependencies with pnpm $(pnpm --version)..."
        pnpm install --frozen-lockfile --prefer-offline
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        
    - name: 📊 Generate Security Metrics
      run: |
        
        # Get test results and coverage
        COVERAGE=$(pnpm run test:coverage 2>/dev/null | grep -oP 'All files.*?(\d+\.?\d*)%' | tail -1 | grep -oP '\d+\.?\d*' || echo "0")
        TEST_RESULTS=$(pnpm run test 2>&1 | grep -oP '\d+ passed' || echo "0 passed")
        
        # Check for security patterns
        UNPROTECTED_ENDPOINTS=$(find src/pages/api -name "*.ts" -type f 2>/dev/null | wc -l || echo "0")
        PROTECTED_ENDPOINTS=$(find src/pages/api -name "*.ts" -type f -exec grep -l "checkRateLimit\|verifyJWT\|ADMIN_API_TOKEN" {} \; 2>/dev/null | wc -l || echo "0")
        
        # Analyze bypass usage
        BYPASS_COUNT=$(grep -c "\[BYPASS\]" ../.security-audit.log 2>/dev/null || echo "0")
        LAST_WEEK_BYPASSES=$(grep "\[BYPASS\]" ../.security-audit.log 2>/dev/null | tail -7 | wc -l || echo "0")
        
        # Current enforcement level
        ENFORCEMENT_LEVEL=$(node -p "JSON.parse(require('fs').readFileSync('../.security-config.json', 'utf8')).enforcement.level" 2>/dev/null || echo "warning")
        
        echo "## 🛡️ Security & Quality Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| 📊 Test Coverage | ${COVERAGE}% | $([ $(echo "$COVERAGE > 70" | bc -l 2>/dev/null || echo 0) -eq 1 ] && echo "✅ Excellent" || echo "⚠️ Needs Improvement") |" >> $GITHUB_STEP_SUMMARY
        echo "| 🧪 Test Results | $TEST_RESULTS | $(echo "$TEST_RESULTS" | grep -q "0 passed" && echo "❌ Failed" || echo "✅ Passing") |" >> $GITHUB_STEP_SUMMARY
        echo "| 🔒 Protected Endpoints | $PROTECTED_ENDPOINTS/$UNPROTECTED_ENDPOINTS | $([ $PROTECTED_ENDPOINTS -eq $UNPROTECTED_ENDPOINTS ] && echo "✅ All Secure" || echo "⚠️ Some Unprotected") |" >> $GITHUB_STEP_SUMMARY
        echo "| 🚪 Total Bypasses | $BYPASS_COUNT | $([ $BYPASS_COUNT -lt 5 ] && echo "✅ Low Usage" || echo "⚠️ High Usage") |" >> $GITHUB_STEP_SUMMARY
        echo "| 📅 Week Bypasses | $LAST_WEEK_BYPASSES | $([ $LAST_WEEK_BYPASSES -lt 2 ] && echo "✅ Acceptable" || echo "⚠️ Review Needed") |" >> $GITHUB_STEP_SUMMARY
        echo "| ⚙️ Enforcement Level | $ENFORCEMENT_LEVEL | $([ "$ENFORCEMENT_LEVEL" = "error" ] && echo "🔒 Strict" || echo "⚠️ Learning") |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Compliance score calculation
        COMPLIANCE_SCORE=$((100 - LAST_WEEK_BYPASSES * 20))
        COMPLIANCE_SCORE=$([ $COMPLIANCE_SCORE -lt 0 ] && echo "0" || echo "$COMPLIANCE_SCORE")
        
        echo "### 📈 Overall Compliance Score: ${COMPLIANCE_SCORE}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ $COMPLIANCE_SCORE -gt 90 ]; then
          echo "🎉 **EXCELLENT SECURITY COMPLIANCE** - Team following best practices!" >> $GITHUB_STEP_SUMMARY
        elif [ $COMPLIANCE_SCORE -gt 70 ]; then
          echo "✅ **GOOD SECURITY COMPLIANCE** - Minor improvements recommended" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ **SECURITY COMPLIANCE NEEDS ATTENTION** - Review patterns and reduce bypasses" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: 🔄 Auto-Escalate Security Enforcement
      run: |
        echo "⚠️ Auto-escalation script not configured for DAO project"
        # node scripts/auto-escalate-security.js
        
    - name: 📋 Final Status
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🎯 Deployment Status" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.security-quality-check.result }}" == "success" ]; then
          echo "🚀 **READY FOR DEPLOYMENT** - All security checks passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "🚨 **DEPLOYMENT BLOCKED** - Security issues must be resolved" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "_Security dashboard updated: $(date -u)_" >> $GITHUB_STEP_SUMMARY